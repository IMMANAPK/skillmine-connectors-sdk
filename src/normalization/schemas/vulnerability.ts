// ============================================
// VULNERABILITY SCHEMA - Complyment Connectors SDK
// ============================================

import { z } from 'zod'

// ============================================
// Zod Schema - Runtime Validation
// ============================================

export const SeveritySchema = z.enum([
    'critical',
    'high',
    'medium',
    'low',
    'info',
])

export const NormalizedVulnerabilitySchema = z.object({
    id: z.string().min(1),
    title: z.string().min(1),
    severity: SeveritySchema,
    cvss: z.number().min(0).max(10).optional(),
    cve: z.string().regex(/^CVE-\d{4}-\d+$/).optional(),
    affectedAsset: z.string().min(1),
    source: z.string().min(1),
    detectedAt: z.date(),
    raw: z.unknown().optional(),
})

export type ValidatedVulnerability = z.infer<typeof NormalizedVulnerabilitySchema>

// ============================================
// Validation Helper
// ============================================

export interface ValidationResult<T> {
    valid: T[]
    invalid: Array<{ data: unknown; errors: string[] }>
}

export function validateVulnerabilities(
    items: unknown[],
): ValidationResult<ValidatedVulnerability> {
    const valid: ValidatedVulnerability[] = []
    const invalid: Array<{ data: unknown; errors: string[] }> = []

    for (const item of items) {
        const result = NormalizedVulnerabilitySchema.safeParse(item)

        if (result.success) {
            valid.push(result.data)
        } else {
            invalid.push({
                data: item,
                errors: result.error.issues.map(
                    (e) => `${e.path.join('.')}: ${e.message}`,
                ),
            })
        }
    }

    return { valid, invalid }
}

// ============================================
// CVSS Score to Severity Mapping
// ============================================

export function cvssToSeverity(
    cvss: number,
): 'critical' | 'high' | 'medium' | 'low' | 'info' {
    if (cvss >= 9.0) return 'critical'
    if (cvss >= 7.0) return 'high'
    if (cvss >= 4.0) return 'medium'
    if (cvss >= 0.1) return 'low'
    return 'info'
}

// ============================================
// Severity to CVSS Range
// ============================================

export function severityToCvssRange(
    severity: string,
): { min: number; max: number } {
    const ranges: Record<string, { min: number; max: number }> = {
        critical: { min: 9.0, max: 10.0 },
        high: { min: 7.0, max: 8.9 },
        medium: { min: 4.0, max: 6.9 },
        low: { min: 0.1, max: 3.9 },
        info: { min: 0.0, max: 0.0 },
    }
    return ranges[severity] ?? { min: 0, max: 0 }
}